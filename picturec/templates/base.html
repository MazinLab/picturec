{% extends 'bootstrap/base.html' %}

{% block head %}
    {{ super() }}
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block title %}
  {% if title %}
  {{ title }} - PICTURE-C
  {% else %}
  PICTURE-C Control
  {% endif %}
{% endblock %}

{% block body %}
<div class="sidenav" style="height:100%; width: 10%; position:fixed; z-index: 1; top: 0; left: 0; overflow-x: hidden; padding-top: 50px; background-color: #111">

    <a href="{{ url_for('index') }}" style="padding: 6px 8px 100px 8px; text-decoration: none; font-size: 20px; color: #818181; display: block">PICTURE-C</a>
    <a href="{{ url_for('index') }}" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 20px; color: #818181; display: block">Home</a>
    <a href="{{ url_for('settings') }}" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 20px; color: #818181; display: block">Settings</a>
    <a href="{{ url_for('test_page') }}" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 20px; color: #818181; display: block">Test Page</a>
    <a style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 20px; color: #818181; display: block">Detector</a>
    <a href="http://localhost:8081" target="_blank" rel="noopener noreferrer" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 20px; color: #818181; display: block">Redis</a>
    <a href="{{ url_for('log_viewer') }}" target="_blank" rel="noopener noreferrer" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 20px; color: #818181; display: block">Log Viewer</a>
    <a href="{{ url_for('other_plots') }}" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 20px; color: #818181; display: block">Other Plots</a>
</div>

<div class="sidenav" style="height:100%; width: 12%; position:fixed; z-index: 1; top: 0; right: 0; overflow-x: hidden; padding-top: 10px; background-color: #111">
    <!--    TODO: Add Status for different agents too.-->
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block">
        <div class="column" style="float: left; margin-left: 8%; width: 40%">Device T:</div>
        <div class="column" style="float: left; width: 50%"><div id="Temp_Report" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">K</div></div>
    </div>

    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block">
        <div class="column" style="float: left; margin-left: 8%; width: 40%">LN2 T:</div>
        <div class="column" style="float: left; width: 50%"><div id="Nitrogen_Temp" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">K</div></div>
    </div>

    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block">
        <div class="column" style="float: left; margin-left: 8%; width: 40%">LHe T:</div>
        <div class="column" style="float: left; width: 50%"><div id="Helium_Temp" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">K</div></div>
    </div>

    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block">
        <div class="column" style="float: left; margin-left: 8%; width: 40%">Current:</div>
        <div class="column" style="float: left; width: 50%"><div id="Meas_Current" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">A</div></div>
    </div>

    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block">
        <div class="column" style="float: left; margin-left: 8%; width: 40%">Heat switch:</div>
        <div class="column" style="float: left; width: 50%"><div id="heatswitch" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left"></div></div>
    </div>

    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block">
        <div class="column" style="float: left; margin-left: 8%; width: 40%">Magnet Status:</div>
        <div class="column" style="float: left; width: 50%"><div id="Magnet_Status" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left"></div></div>
    </div>

    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block">
        <div class="column" style="float: left; margin-left: 8%; width: 40%">Agent X Status:</div>
        <div class="column" style="float: left; width: 50%"><div id="Agent_Status" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left"></div></div>
    </div>

<!--    HEMTS Below -->
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 18px; color: #818181; display: block">
        <div class="column" style="text-align: center">HEMTs</div>
    </div>

    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">V<sub>drain,1</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt1Vd" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">V</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">V<sub>drain,2</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt2Vd" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">V</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">V<sub>drain,3</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt3Vd" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">V</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">V<sub>drain,4</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt4Vd" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">V</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">V<sub>drain,5</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt5Vd" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">V</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">V<sub>gate,1</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt1Vg" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">V</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">V<sub>gate,2</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt2Vg" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">V</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">V<sub>gate,3</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt3Vg" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">V</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">V<sub>gate,4</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt4Vg" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">V</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">V<sub>gate,5</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt5Vg" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">V</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">I<sub>drain,1</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt1Id" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">mA</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">I<sub>drain,2</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt2Id" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">mA</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">I<sub>drain,3</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt3Id" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">mA</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">I<sub>drain,4</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt4Id" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">mA</div></div></div>
    <div class="row" style="padding: 6px 8px 6px 8px; text-decoration: none; font-size: 15px; color: #818181; display: block"><div class="column" style="float: left; margin-left: 8%; width: 40%">I<sub>drain,5</sub></div><div class="column" style="float: left; width: 50%"><div id="Hemt5Id" style="display: inline; float: left; padding-right: 3px"></div><div style="display: inline; float: left">mA</div></div></div>
</div>

    <script>
        function update_base_page() {
            var source = new EventSource("/listener");
            source.addEventListener("message", function (e) {
                var newdata = JSON.parse(e.data);
                // console.log("Message: ", newdata);
                update_div("Helium_Temp", "status:temps:lhetank", newdata, true);
                update_div("Nitrogen_Temp", "status:temps:ln2tank", newdata, true);
                update_div("Temp_Report", "status:temps:mkidarray:temp", newdata, true);
                update_div("Meas_Current", "status:device:sim960:current-setpoint", newdata, true);
                update_div("Magnet_Status", "status:magnet:state", newdata);
                update_div("heatswitch", "device-settings:currentduino:heatswitch", newdata);
                update_div("Hemt1Vd", "status:feedline1:hemt:drain-voltage-bias", newdata, true);
                update_div("Hemt2Vd", "status:feedline2:hemt:drain-voltage-bias", newdata, true);
                update_div("Hemt3Vd", "status:feedline3:hemt:drain-voltage-bias", newdata, true);
                update_div("Hemt4Vd", "status:feedline4:hemt:drain-voltage-bias", newdata, true);
                update_div("Hemt5Vd", "status:feedline5:hemt:drain-voltage-bias", newdata, true);
                update_div("Hemt1Vg", "status:feedline1:hemt:gate-voltage-bias", newdata, true);
                update_div("Hemt2Vg", "status:feedline2:hemt:gate-voltage-bias", newdata, true);
                update_div("Hemt3Vg", "status:feedline3:hemt:gate-voltage-bias", newdata, true);
                update_div("Hemt4Vg", "status:feedline4:hemt:gate-voltage-bias", newdata, true);
                update_div("Hemt5Vg", "status:feedline5:hemt:gate-voltage-bias", newdata, true);
                update_div("Hemt1Id", "status:feedline1:hemt:drain-current-bias", newdata, true);
                update_div("Hemt2Id", "status:feedline2:hemt:drain-current-bias", newdata, true);
                update_div("Hemt3Id", "status:feedline3:hemt:drain-current-bias", newdata, true);
                update_div("Hemt4Id", "status:feedline4:hemt:drain-current-bias", newdata, true);
                update_div("Hemt5Id", "status:feedline5:hemt:drain-current-bias", newdata, true);
            }, false);
            source.addEventListener("open", function (e) {
                console.log('Connection was opened: ', e);
            }, false);
            source.addEventListener("error", function (e) {
                console.log("Connection errored out: ", e);
            }, false);
        };
        update_base_page()

        function update_div(div, key, sentdata, ts=false) {
            var data = sentdata[key];
            if (ts) {
                var time = data[2];
                var value = Number(data[1]).toFixed(3);
            } else {
                var value = data;
            }
            $("#"+div).text(value)
        };

        function update_plot(div, key, sentdata, trace=0) {
            var data = sentdata[key];
            var time = data[2];
            var value = data[1];
            Plotly.extendTraces(div, {x:[[time]], y:[[value]]}, [trace])
        }

        function realtime_validate(id) {
            $("#"+id).keyup(function () {
                var text = $(this).val();
                $.ajax({
                    type:'POST',
                    url:'/validatecmd',
                    data:{
                        id:id,
                        data:text
                    },
                    success:function(d){
                        $("#"+id+"_success").text(d['legal'][1]);
                        if (d['legal'][0] == false) {
                            document.getElementById(id).style.color = 'red'
                        } else {
                            document.getElementById(id).style.color = 'blue'
                        }
                        console.log(d);
                    }
                })
            })
        }

        function subdata(id, url) {
            $(document).on('submit', "#"+id+"_form", function(e){
               e.preventDefault();
               $.ajax({
                   type:'POST',
                   url:url,
                   data:{
                       id:id,
                       data:$("#"+id).val()
                   },
                   success:function(d)
                   {
                       $("#"+id+"_success").text(d['legal'][1])
                       if (d['legal'][0] == false) {
                            document.getElementById(id).style.color = 'red'
                        } else {
                            document.getElementById(id).style.color = 'blue'
                        }
                        if (d['cycle'] == true) {
                            var msg;
                            console.log(d['key'])
                            if (d['key'] == 'command:get-cold'){
                                msg = "Started cooldown at: ";
                            } else if (d['key'] == 'command:abort-cooldown') {
                                msg = "Cooldown aborted at: ";
                            } else if (d['key'] == 'command:cancel-scheduled-cooldown') {
                                msg = "Canceled previously scheduled cooldown at: ";
                            } else if (d['key'] == 'command:be-cold-at') {
                                if (d['legal'][0] == true) {
                                    msg = "Scheduling cooldown for: ";
                                } else {
                                    msg = "ILLEGAL TIME OR FORMAT! Cannot schedule cooldown for: ";
                                }
                            }
                            $("#ButtonData").text(msg+d['value'])
                        }
                       console.log(d);
                   }
               })
            });
        }

        function register_realtime_validation(keys) {
            var i;
            var k = keys;
            for (i=0; i < k.length; i++) {
                realtime_validate(k[i])
            }
        }

        function register_submitters(keys, url) {
            var i;
            var k = keys;
            for (i=0; i < k.length; i++) {
                subdata(k[i], url)
            }
        }

        function update_multiple_divs(id_and_redis_names, data) {
            var i;
            var keys = id_and_redis_names;
            for (i=0; i < keys.length; i++) {
                update_div(keys[i][0]+"_currentval", keys[i][1], data);
            }
        }
    </script>
{% endblock%}
